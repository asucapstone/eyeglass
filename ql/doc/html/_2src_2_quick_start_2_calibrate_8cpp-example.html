<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>Quick Link 2: /src/QuickStart/Calibrate.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Quick Link 2
   &#160;<span id="projectnumber">v 2.7.3.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Home</span></a></li>
      <li><a href="modules.html"><span>Sections</span></a></li>
      <li><a href="files.html"><span>Header&#160;Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">/src/QuickStart/Calibrate.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;QL2Utility.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Calibrate.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;opencvUtility.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> DrawTarget(IplImage* image, CvPoint center, <span class="keywordtype">int</span> radius, CvScalar color)</div>
<div class="line">{</div>
<div class="line">    DrawCross(image, center, radius, color, 2);</div>
<div class="line">    cvCircle(image, center, radius, CV_RGB(50, 50, 50), radius);</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> DisplayCalibration(</div>
<div class="line">    IplImage* displayImage, </div>
<div class="line">    <span class="keyword">const</span> <a name="_a0"></a><a class="code" href="struct_q_l_calibration_target.html">QLCalibrationTarget</a>* targets, </div>
<div class="line">    <span class="keyword">const</span> <a name="_a1"></a><a class="code" href="struct_q_l_calibration_score.html">QLCalibrationScore</a>* leftScores, </div>
<div class="line">    <span class="keyword">const</span> <a class="code" href="struct_q_l_calibration_score.html">QLCalibrationScore</a>* rightScores,</div>
<div class="line">    <span class="keywordtype">int</span> numTargets,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> * windowName)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> tx = 0;</div>
<div class="line">    <span class="keywordtype">int</span> ty = 0;</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Clear the calibration window</span></div>
<div class="line">    memset(displayImage-&gt;imageData, 128, displayImage-&gt;imageSize);</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Loop through each target.</span></div>
<div class="line">    printf_s(<span class="stringliteral">&quot;\nCalibration Scores\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; numTargets; i++)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Draw the target positions</span></div>
<div class="line">        tx = (int)targets[i].x * displayImage-&gt;width / 100;</div>
<div class="line">        ty = (<span class="keywordtype">int</span>)targets[i].<a name="a2"></a><a class="code" href="struct_q_l_calibration_target.html#aa4f0d3eebc3c443f9be81bf48561a217">y</a> * displayImage-&gt;height / 100;</div>
<div class="line">        DrawTarget(displayImage, cvPoint(tx, ty),  20, CV_RGB(50, 50, 50));</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Draw the left </span></div>
<div class="line">        tx = (int)(targets[i].x + leftScores[i].x) * displayImage-&gt;width / 100;</div>
<div class="line">        ty = (int)(targets[i].y + leftScores[i].y) * displayImage-&gt;height / 100;</div>
<div class="line">        DrawCross(displayImage, cvPoint(tx, ty), 10, CV_RGB(0, 255, 255), 1);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Draw the right </span></div>
<div class="line">        tx = (int)(targets[i].x + rightScores[i].x) * displayImage-&gt;width / 100;</div>
<div class="line">        ty = (int)(targets[i].y + rightScores[i].y) * displayImage-&gt;height / 100;</div>
<div class="line">        DrawCross(displayImage, cvPoint(tx, ty), 10, CV_RGB(255, 0, 0), 1);</div>
<div class="line"></div>
<div class="line">        cvShowImage(windowName, displayImage);</div>
<div class="line"></div>
<div class="line">        printf_s(<span class="stringliteral">&quot;%2.2f %2.2f &quot;</span>, leftScores[i].score, rightScores[i].score);</div>
<div class="line">    }</div>
<div class="line">    printf_s(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> CalibrateTarget(</div>
<div class="line">    <a class="code" href="group___calibration.html#gacf8176ed52d293205408db3fe2d53d78">QLCalibrationId</a> calibrationId,</div>
<div class="line">    <a class="code" href="struct_q_l_calibration_target.html">QLCalibrationTarget</a> target,</div>
<div class="line">    IplImage* displayImage,</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* windowName)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Loop on this target until eye data was successfully collected for each</span></div>
<div class="line">    <span class="comment">// eye.</span></div>
<div class="line">    <a class="code" href="_q_l_types_8h.html#a6bad519fb3f9d94813b6feb7e2440b45">QLCalibrationStatus</a> status = <a name="a3"></a><a class="code" href="_q_l_types_8h.html#a6bad519fb3f9d94813b6feb7e2440b45aa5c30149a5e1510c35b9cdc4461ea415">QL_CALIBRATION_STATUS_OK</a>;</div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">//Clear the calibration window</span></div>
<div class="line">        memset(displayImage-&gt;imageData, 128, displayImage-&gt;imageSize);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Display the cleared image buffer in the calibration window.</span></div>
<div class="line">        cvShowImage(windowName, displayImage);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Wait for a little bit so show the blanked screen.</span></div>
<div class="line">        <span class="keywordflow">if</span>(cvWaitKeyEsc == cvWaitKey(100))</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// The target positions are in percentage of the area to be tracked so</span></div>
<div class="line">        <span class="comment">// we need to scale to the calibration window size.</span></div>
<div class="line">        <span class="keywordtype">int</span> tx = (int)target.<a name="a4"></a><a class="code" href="struct_q_l_calibration_target.html#ad0da36b2558901e21e7a30f6c227a45e">x</a> * displayImage-&gt;width / 100;</div>
<div class="line">        <span class="keywordtype">int</span> ty = (<span class="keywordtype">int</span>)target.<a class="code" href="struct_q_l_calibration_target.html#aa4f0d3eebc3c443f9be81bf48561a217">y</a> * displayImage-&gt;height / 100;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Draw a target to the image buffer</span></div>
<div class="line">        DrawTarget(displayImage, cvPoint(tx, ty),  20, CV_RGB(0, 255, 0));</div>
<div class="line">            </div>
<div class="line">        <span class="comment">// Display the image buffer in the calibration window.</span></div>
<div class="line">        cvShowImage(windowName, displayImage);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Wait a little bit so the user can see the target before we calibrate.</span></div>
<div class="line">        cvWaitKey(250);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Calibrate the target for 1000 ms. This can be done two ways; blocking and</span></div>
<div class="line">        <span class="comment">// non-blocking. For blocking set the block variable to true. for</span></div>
<div class="line">        <span class="comment">// non-blocking set it to false. </span></div>
<div class="line">        <span class="keywordtype">bool</span> block = <span class="keyword">false</span>;</div>
<div class="line">        <a name="a5"></a><a class="code" href="group___calibration.html#ga9fc8ca4bdaececca39f7716147400ec7">QLCalibration_Calibrate</a>(calibrationId, target.<a name="a6"></a><a class="code" href="struct_q_l_calibration_target.html#a0559f260a4bf2fa03c9ae4cf83c843c5">targetId</a>, 1500, block);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// When non-blocking is used, the status of the target needs to be</span></div>
<div class="line">        <span class="comment">// polled to determine when it has finished. During the polling we can</span></div>
<div class="line">        <span class="comment">// do other things like querying user input as we do here to see if</span></div>
<div class="line">        <span class="comment">// the user wants to quit the calibration.</span></div>
<div class="line">        <span class="keywordtype">int</span> keyPressed = 0;</div>
<div class="line">        <span class="keywordflow">while</span>(!block &amp;&amp;</div>
<div class="line">            ((keyPressed = cvWaitKey(10)) != cvWaitKeyEsc) &amp;&amp;</div>
<div class="line">            (<a name="a7"></a><a class="code" href="group___calibration.html#ga2db22c509f2f41a3db5f665f009579f0">QLCalibration_GetStatus</a>(calibrationId, target.<a class="code" href="struct_q_l_calibration_target.html#a0559f260a4bf2fa03c9ae4cf83c843c5">targetId</a>, &amp;status) == <a name="a8"></a><a class="code" href="_q_l_types_8h.html#a22d4c0db9d20a9918bd5947d67977468a51dc4f37a376c25bf1d7c91ded3c8bbc">QL_ERROR_OK</a>) &amp;&amp;</div>
<div class="line">            (status == <a name="a9"></a><a class="code" href="_q_l_types_8h.html#a6bad519fb3f9d94813b6feb7e2440b45ae0cfdfddf0debab456917051120868a1">QL_CALIBRATION_STATUS_CALIBRATING</a>));</div>
<div class="line"></div>
<div class="line">        <span class="comment">// If the user terminated the calibration early then return false.</span></div>
<div class="line">        <span class="keywordflow">if</span>(keyPressed == cvWaitKeyEsc)</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Get the status of the target.</span></div>
<div class="line">        <a class="code" href="group___calibration.html#ga2db22c509f2f41a3db5f665f009579f0">QLCalibration_GetStatus</a>(calibrationId, target.<a class="code" href="struct_q_l_calibration_target.html#a0559f260a4bf2fa03c9ae4cf83c843c5">targetId</a>, &amp;status);</div>
<div class="line">    }<span class="keywordflow">while</span>(status != <a class="code" href="_q_l_types_8h.html#a6bad519fb3f9d94813b6feb7e2440b45aa5c30149a5e1510c35b9cdc4461ea415">QL_CALIBRATION_STATUS_OK</a>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Return true to indicate that the target has successfully been calibrated</span></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> AutoCalibrate(</div>
<div class="line">    <a class="code" href="group___device.html#ga8b6d16f8cfb0599ab2558552fb3e9291">QLDeviceId</a> deviceId, </div>
<div class="line">    <a class="code" href="_q_l_types_8h.html#a15c70c494a2a5f81aa244079be65b99b">QLCalibrationType</a> calibrationType,  </div>
<div class="line">    <a class="code" href="group___calibration.html#gacf8176ed52d293205408db3fe2d53d78">QLCalibrationId</a>* calibrationId)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="_q_l_types_8h.html#a22d4c0db9d20a9918bd5947d67977468">QLError</a> qlerror = <a class="code" href="_q_l_types_8h.html#a22d4c0db9d20a9918bd5947d67977468a51dc4f37a376c25bf1d7c91ded3c8bbc">QL_ERROR_OK</a>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Initialize the calibration using the inputed data.</span></div>
<div class="line">    qlerror = <a name="a10"></a><a class="code" href="group___calibration.html#gaded967a0ae788dd19d27b273250a8897">QLCalibration_Initialize</a>(deviceId, *calibrationId, calibrationType);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// If the calibrationId was not valid then create a new calibration</span></div>
<div class="line">    <span class="comment">// container and use it.</span></div>
<div class="line">    <span class="keywordflow">if</span>(qlerror == <a name="a11"></a><a class="code" href="_q_l_types_8h.html#a22d4c0db9d20a9918bd5947d67977468ac6c6ca2fb3c494126d60b92778ba7250">QL_ERROR_INVALID_CALIBRATION_ID</a>)</div>
<div class="line">    {</div>
<div class="line">        <a name="a12"></a><a class="code" href="group___calibration.html#ga8d67cbb11337c20a6b2db79d3532e917">QLCalibration_Create</a>(0, calibrationId);</div>
<div class="line">        qlerror = <a class="code" href="group___calibration.html#gaded967a0ae788dd19d27b273250a8897">QLCalibration_Initialize</a>(deviceId, *calibrationId, calibrationType);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// If the initialization failed then print an error and return false.</span></div>
<div class="line">    <span class="keywordflow">if</span>(qlerror == <a name="a13"></a><a class="code" href="_q_l_types_8h.html#a22d4c0db9d20a9918bd5947d67977468ae9fe8fb76709d3aa9381c2230eeedc9f">QL_ERROR_INVALID_DEVICE_ID</a>)</div>
<div class="line">    {</div>
<div class="line">        printf_s(<span class="stringliteral">&quot;QLCalibration_Initialize() failed with error code %d.\n&quot;</span>, qlerror);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Create a buffer for the targets. This just needs to be large enough to</span></div>
<div class="line">    <span class="comment">// hold the targets. </span></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> bufferSize = 20;</div>
<div class="line">    <span class="keywordtype">int</span> numTargets = bufferSize;</div>
<div class="line">    <a class="code" href="struct_q_l_calibration_target.html">QLCalibrationTarget</a> targets[bufferSize];</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Get the targets. After the call, numTargets will contain the number of</span></div>
<div class="line">    <span class="comment">// actual targets. </span></div>
<div class="line">    qlerror = <a name="a14"></a><a class="code" href="group___calibration.html#ga92c14e11b16a611161996f4567a29bfd">QLCalibration_GetTargets</a>(*calibrationId, &amp;numTargets, targets);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// If the buffer was not large enough then print an error and return false.</span></div>
<div class="line">    <span class="keywordflow">if</span>(qlerror == <a name="a15"></a><a class="code" href="_q_l_types_8h.html#a22d4c0db9d20a9918bd5947d67977468a40eaa477d3d57e1f9e54521219239065">QL_ERROR_BUFFER_TOO_SMALL</a>)</div>
<div class="line">    {</div>
<div class="line">        printf_s(</div>
<div class="line">            <span class="stringliteral">&quot;The target buffer is too small. It should be at least %d bytes.\n&quot;</span>, </div>
<div class="line">            numTargets * <span class="keyword">sizeof</span>(<a class="code" href="struct_q_l_calibration_target.html">QLCalibrationTarget</a>));</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line"></div>
<div class="line">    <span class="comment">// Use OpenCV to create a window for doing the calibration. The calibration</span></div>
<div class="line">    <span class="comment">// will only be valid over the area of this window. If the entire screen</span></div>
<div class="line">    <span class="comment">// area is to be calibrated then this window should be set to the screen</span></div>
<div class="line">    <span class="comment">// size. </span></div>
<div class="line">    <span class="keywordtype">int</span> windowWidth = 1024;</div>
<div class="line">    <span class="keywordtype">int</span> windowHeight = 768;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* windowName = <span class="stringliteral">&quot;Calibration Window&quot;</span>;</div>
<div class="line">    IplImage* displayImage = cvCreateImage(cvSize(windowWidth, windowHeight), 8, 3);</div>
<div class="line">    cvNamedWindow(windowName, CV_WINDOW_AUTOSIZE);</div>
<div class="line">    cvMoveWindow(windowName, 0, 0);</div>
<div class="line">    cvResizeWindow(windowName, windowWidth, windowHeight);</div>
<div class="line"></div>
<div class="line">    <span class="comment">//Clear the calibration window</span></div>
<div class="line">    memset(displayImage-&gt;imageData, 128, displayImage-&gt;imageSize);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Create a font for printing to the window.</span></div>
<div class="line">    CvFont font;</div>
<div class="line">    cvInitFont(&amp;font,CV_FONT_HERSHEY_SIMPLEX, .5, .5, 0, 1);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Print a message to the image.</span></div>
<div class="line">    <span class="keywordtype">int</span> lineSize = 20;</div>
<div class="line">    <span class="keywordtype">int</span> lineIndent = 10;</div>
<div class="line">    cvPutText(</div>
<div class="line">        displayImage, </div>
<div class="line">        <span class="stringliteral">&quot;The calibration is dependant on the location of the calibration area.&quot;</span>,</div>
<div class="line">        cvPoint(lineIndent, lineSize * 1),</div>
<div class="line">        &amp;font,</div>
<div class="line">        CV_RGB(255, 255, 255));</div>
<div class="line">    cvPutText(</div>
<div class="line">        displayImage, </div>
<div class="line">        <span class="stringliteral">&quot;Move the window to the area of the screen you would like calibrate.&quot;</span>,</div>
<div class="line">        cvPoint(lineIndent, lineSize * 2),</div>
<div class="line">        &amp;font,</div>
<div class="line">        CV_RGB(255, 255, 255));</div>
<div class="line">    cvPutText(</div>
<div class="line">        displayImage, </div>
<div class="line">        <span class="stringliteral">&quot;Press ENTER when ready.&quot;</span>,</div>
<div class="line">        cvPoint(lineIndent, lineSize * 3),</div>
<div class="line">        &amp;font,</div>
<div class="line">        CV_RGB(255, 255, 255));</div>
<div class="line">    cvPutText(</div>
<div class="line">        displayImage, </div>
<div class="line">        <span class="stringliteral">&quot;Press ESC at any time to terminate the calibration&quot;</span>,</div>
<div class="line">        cvPoint(lineIndent, lineSize * 4),</div>
<div class="line">        &amp;font,</div>
<div class="line">        CV_RGB(255, 255, 255));</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Display the image to the window.</span></div>
<div class="line">    cvShowImage(windowName, displayImage);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Wait for the user to place the window and press a key.</span></div>
<div class="line">    <span class="keywordflow">if</span>(cvWaitKey() == cvWaitKeyEsc)</div>
<div class="line">    {</div>
<div class="line">        <a name="a16"></a><a class="code" href="group___calibration.html#ga1d8d8dba5865cce5ada65e778c0cc92f">QLCalibration_Cancel</a>(*calibrationId);</div>
<div class="line">        cvReleaseImage(&amp;displayImage);</div>
<div class="line">        cvDestroyWindow(windowName);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Loop through each target and calibrate them</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; numTargets; i++) </div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Calibrate each target. If the user terminates the calibration then</span></div>
<div class="line">        <span class="comment">// return false.</span></div>
<div class="line">        <span class="keywordflow">if</span>(!CalibrateTarget(</div>
<div class="line">            *calibrationId, </div>
<div class="line">            targets[i],</div>
<div class="line">            displayImage,</div>
<div class="line">            windowName))</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="group___calibration.html#ga1d8d8dba5865cce5ada65e778c0cc92f">QLCalibration_Cancel</a>(*calibrationId);</div>
<div class="line">            cvReleaseImage(&amp;displayImage);</div>
<div class="line">            cvDestroyWindow(windowName);</div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">        }</div>
<div class="line">            </div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Get the scores and display them. If the user wants to improve the</span></div>
<div class="line">    <span class="comment">// calibration then recalibrate the worst target and loop through again.</span></div>
<div class="line">    <span class="keywordtype">int</span> keyPress = 0;</div>
<div class="line">    <span class="keywordflow">do</span></div>
<div class="line">    { </div>
<div class="line">        <span class="comment">// When all calibration targets have been successfully calibrated then get</span></div>
<div class="line">        <span class="comment">// the scoring. Scores can only be calculated once all targets have been</span></div>
<div class="line">        <span class="comment">// calibrated.</span></div>
<div class="line">        <a class="code" href="struct_q_l_calibration_score.html">QLCalibrationScore</a> leftScores[bufferSize];</div>
<div class="line">        <a class="code" href="struct_q_l_calibration_score.html">QLCalibrationScore</a> rightScores[bufferSize];</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; numTargets; i++) </div>
<div class="line">        {</div>
<div class="line">            <a name="a17"></a><a class="code" href="group___calibration.html#ga270ec1fb82c64d90933b09b31b2a41c4">QLCalibration_GetScoring</a>(</div>
<div class="line">                *calibrationId, </div>
<div class="line">                targets[i].targetId, </div>
<div class="line">                <a name="a18"></a><a class="code" href="_q_l_types_8h.html#a0e337d82e818280b6e8a399527353d06acd691c66984175d6469d6821291533f0">QL_EYE_TYPE_LEFT</a>, </div>
<div class="line">                leftScores + i);</div>
<div class="line"></div>
<div class="line">            <a class="code" href="group___calibration.html#ga270ec1fb82c64d90933b09b31b2a41c4">QLCalibration_GetScoring</a>(</div>
<div class="line">                *calibrationId, </div>
<div class="line">                targets[i].targetId, </div>
<div class="line">                <a name="a19"></a><a class="code" href="_q_l_types_8h.html#a0e337d82e818280b6e8a399527353d06aa1a65ece220708916a24570756719054">QL_EYE_TYPE_RIGHT</a>, </div>
<div class="line">                rightScores + i);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Display the calibration results graphically.</span></div>
<div class="line">        DisplayCalibration(displayImage, targets, leftScores, rightScores, numTargets, windowName);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Wait for user input to determine what to do.</span></div>
<div class="line">        keyPress = cvWaitKey();</div>
<div class="line"></div>
<div class="line">        <span class="comment">// If the user wants to improve the calibration then determine which</span></div>
<div class="line">        <span class="comment">// target has the largest score and recalibrate it.</span></div>
<div class="line">        <span class="keywordflow">if</span>(keyPress == <span class="charliteral">&#39;i&#39;</span>)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">float</span> highestScore = 0;</div>
<div class="line">            <span class="keywordtype">int</span> highestIndex = 0;</div>
<div class="line">            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; numTargets; i++) </div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span>(leftScores[i].score &gt; highestScore)</div>
<div class="line">                {</div>
<div class="line">                    highestScore = leftScores[i].<a name="a20"></a><a class="code" href="struct_q_l_calibration_score.html#a8c5cd9b525ee73a24b1d9d8e34982d1c">score</a>;</div>
<div class="line">                    highestIndex = i;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">if</span>(rightScores[i].score &gt; highestScore)</div>
<div class="line">                {</div>
<div class="line">                    highestScore = rightScores[i].<a class="code" href="struct_q_l_calibration_score.html#a8c5cd9b525ee73a24b1d9d8e34982d1c">score</a>;</div>
<div class="line">                    highestIndex = i;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// Calibrate the target. If the user terminates the calibration then</span></div>
<div class="line">            <span class="comment">// return false.</span></div>
<div class="line">            <span class="keywordflow">if</span>(!CalibrateTarget(</div>
<div class="line">                *calibrationId, </div>
<div class="line">                targets[highestIndex],</div>
<div class="line">                displayImage,</div>
<div class="line">                windowName))</div>
<div class="line">            {</div>
<div class="line">                <a class="code" href="group___calibration.html#ga1d8d8dba5865cce5ada65e778c0cc92f">QLCalibration_Cancel</a>(*calibrationId);</div>
<div class="line">                cvReleaseImage(&amp;displayImage);</div>
<div class="line">                cvDestroyWindow(windowName);</div>
<div class="line">                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">    }<span class="keywordflow">while</span>(keyPress == <span class="charliteral">&#39;i&#39;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// If the user would not like to save the calibration then cancel the</span></div>
<div class="line">    <span class="comment">// calibration and return false.</span></div>
<div class="line">    <span class="keywordflow">if</span>(keyPress == cvWaitKeyEsc)</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="group___calibration.html#ga1d8d8dba5865cce5ada65e778c0cc92f">QLCalibration_Cancel</a>(*calibrationId);</div>
<div class="line">        cvReleaseImage(&amp;displayImage);</div>
<div class="line">        cvDestroyWindow(windowName);</div>
<div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <a name="a21"></a><a class="code" href="group___calibration.html#ga8211da9d75f2e95c463e46e0afe0a86e">QLCalibration_Finalize</a>(*calibrationId);</div>
<div class="line">    cvReleaseImage(&amp;displayImage);</div>
<div class="line">    cvDestroyWindow(windowName);</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Jun 2 2015 15:42:46 for Quick Link 2 by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.9.1
</small></address>
</body>
</html>
